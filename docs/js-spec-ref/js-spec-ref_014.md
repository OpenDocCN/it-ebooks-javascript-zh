# 2.10 JavaScript 编程风格

所谓"编程风格"（programming style），指的是编写代码的样式规则。不同的程序员，往往有不同的编程风格。

有人说，编译器的规范叫做"语法规则"（grammar），这是程序员必须遵守的；而编译器忽略的部分，就叫"编程风格"（programming style），这是程序员可以自由选择的。这种说法不完全正确，程序员固然可以自由选择编程风格，但是好的编程风格有助于写出质量更高、错误更少、更易于维护的程序。

所以，"编程风格"的选择不应该基于个人爱好、熟悉程度、打字量等因素，而要考虑如何尽量使代码清晰易读、减少出错。你选择的，不是你喜欢的风格，而是一种能够清晰表达你的意图的风格。这一点，对于 JavaScript 这种语法自由度很高的语言尤其重要。

必须牢记的一点是，如果你选定了一种“编程风格”，就应该坚持遵守，切忌多种风格混用。如果你加入他人的项目，就应该遵守现有的风格。

*   语法标记的风格
    *   大括号的位置
    *   圆括号
    *   缩进
    *   行尾的分号
    *   区块
    *   语法命令的风格
        *   全局变量
        *   new 命令
        *   变量声明
        *   with 语句
        *   相等和严格相等
        *   语句的合并
        *   自增和自减运算符
        *   switch...case 结构
        *   eval 函数
    *   参考链接

## 语法标记的风格

### 大括号的位置

绝大多数的编程语言，都用大括号（{}）表示区块（block）。起首的大括号的位置，有许多不同的写法。

最流行的有两种。一种是起首的大括号另起一行：

```
block
{
　　...
}
```

另一种是起首的大括号跟在关键字的后面：

```
block {
　　...
}
```

一般来说，这两种写法都可以接受。但是，JavaScript 要使用后一种，因为 JavaScript 会自动添加句末的分号，导致一些难以察觉的错误。

```
return
{
　　key:value;
};
```

上面的代码的原意，是要返回一个对象，但实际上返回的是 undefined，因为 JavaScript 自动在 return 语句后面添加了分号。为了避免这一类错误，需要写成下面这样：

```
return {
　　key : value;
};
```

因此，表示区块起首的大括号，不要另起一行。

### 圆括号

圆括号（parentheses）在 JavaScript 中有两种作用，一种表示函数的调用，另一种表示表达式的组合（grouping）。

```
console.log("abc") // 圆括号表示函数的调用
(1+2) * 3 // 圆括号表示表达式的组合
```

我们可以用空格，区分这两种不同的括号。

1.  表示函数调用时，函数名与左括号之间没有空格。

2.  表示函数定义时，函数名与左括号之间没有空格。

3.  其他情况时，前面位置的语法元素与左括号之间，都有一个空格。

按照上面的规则，下面的写法都是不规范的：

```
foo (bar)
return(a+b);
if(a === 0) {...}
function foo (b) {...}
function(x) {...}
```

上面代码的最后一行是一个匿名函数，function 是语法关键字，不是函数名，所以与左括号之间应该要有一个空格。

### 缩进

空格和 Tab 键，都可以产生缩进效果（intent）。Tab 键可以节省击键次数，但不同的文本编辑器对 Tab 的显示不尽相同，有的显示四个空格，有的显示两个空格，所以有人觉得，空格键可以使得显示效果更统一。

无论你选择哪一种方法，都是可以接受的，要做的就是始终坚持这一种选择。不要一会使用 tab 键，一会使用空格键。

### 行尾的分号

分号表示语句的结束。大多数情况下，如果你省略了句尾的分号，JavaScript 会自动添加。

```
var a = 1
```

等同于

```
var a = 1;
```

因此，有人提倡省略句尾的分号。但麻烦的是，如果句尾的最后一个字符与下一行的第一个字符，可以连在一起解释，JavaScript 就不会自动添加分号，这会产生一些难以察觉的错误。

```
x = y
(function (){
　　...
})();
```

上面的代码等同于

```
x = y(function (){...})();
```

因此，不要省略句末的分号。

### 区块

如果循环和判断的代码体只有一行，JavaScript 允许该区块（block）省略大括号。

下面的代码

```
if (a) b(); c();
```

原意可能是

```
if (a) { b(); c();}
```

但是，实际效果是

```
if (a) { b();} c();
```

因此，总是使用大括号表示区块。

## 语法命令的风格

### 全局变量

JavaScript 最大的语法缺点，可能就是全局变量对于任何一个代码块，都是可读可写。这对代码的模块化和重复使用，非常不利。

因此，避免使用全局变量；如果不得不使用，用大写字母表示变量名，比如 UPPER_CASE。

### new 命令

JavaScript 使用 new 命令，从构造函数生成一个新对象。

```
var o = new myObject();
```

这种做法的问题是，一旦你忘了加上 new，myObject()内部的 this 关键字就会指向全局对象，导致所有绑定在 this 上面的变量，都变成全局变量。

因此，尽量使用 Object.create()命令，替代 new 命令。如果不得不使用 new，为了防止出错，最好在视觉上把构造函数与其他函数区分开来。比如，构造函数的函数名，采用首字母大写（InitialCap）；其他函数名，一律首字母小写。

### 变量声明

JavaScript 会自动将变量声明"提升"（hoist）到代码块（block）的头部。

```
if (!o) {
　　var o = {};
}
```

等同于

```
var o;
if (!o) {
　　o = {};
}
```

为了避免可能出现的问题，不如把变量声明都放在代码块的头部。

```
for (var i ...) {...}
```

最好写成：

```
var i;

for (i ...) {...}
```

因此，所有变量声明都放在函数的头部，所有函数都在使用之前定义。

### with 语句

with 可以减少代码的书写，但是会造成混淆。

```
with (o) {
　　foo = bar;
}
```

上面的代码，可以有四种运行结果：

```
o.foo = bar;
o.foo = o.bar;
foo = bar;
foo = o.bar;
```

这四种结果都可能发生，取决于不同的变量是否有定义。因此，不要使用 with 语句。

### 相等和严格相等

JavaScript 有两个表示"相等"的运算符："相等"（==）和"严格相等"（===）。

因为"相等"运算符会自动转换变量类型，造成很多意想不到的情况：

```
0 == ''// true
1 == true // true
2 == true // false
0 == '0' // true
false == 'false' // false
false == '0' // true
" \t\r\n " == 0 // true
```

因此，不要使用"相等"（==）运算符，只使用"严格相等"（===）运算符。

### 语句的合并

有些程序员追求简洁，喜欢合并不同目的的语句。比如，原来的语句是

```
a = b;
if (a) {...}
```

他喜欢写成下面这样:

```
if (a = b) {...}
```

虽然语句少了一行，但是可读性大打折扣，而且会造成误读，让别人误以为这行代码的意思是：

```
if （a === b）{...}
```

另外一种情况是，有些程序员喜欢在同一行中赋值多个变量：

```
var a = b = 0;
```

他以为，这行代码等同于

```
var a = 0, b = 0;
```

实际上不是，它的真正效果是下面这样：

```
b = 0;

var a = b;
```

因此，不要将不同目的的语句，合并成一行。

### 自增和自减运算符

自增（++）和自减（--）运算符，放在变量的前面或后面，返回的值不一样，很容易发生错误。

事实上，所有的++运算符都可以用"+= 1"代替。

```
++x
```

等同于

```
x += 1;
```

代码变得更清晰了。有一个很可笑的例子，某个 JavaScript 函数库的源代码中出现了下面的片段：

```
++x;
++x;
```

这个程序员忘了，还有更简单、更合理的写法：

```
x += 2;
```

因此，不要使用自增（++）和自减（--）运算符，用+=和-=代替。

### switch...case 结构

switch...case 结构要求，在每一个 case 的最后一行必须是 break 语句，否则会接着运行下一个 case。这样不仅容易忘记，还会造成代码的冗长。

而且，switch...case 不使用大括号，不利于代码形式的统一。此外，这种结构类似于 goto 语句，容易造成程序流程的混乱，使得代码结构混乱不堪，不符合面向对象编程的原则。

```
function doAction(action) {
  switch (action) {
    case 'hack':
      return 'hack';
    break;

    case 'slash':
      return 'slash';
    break;

    case 'run':
      return 'run';
    break;

    default:
      throw new Error('Invalid action.');
    break;
  }
}
```

上面的代码建议改写成对象结构。

```
function doAction(action) {
  var actions = {
    'hack': function () {
      return 'hack';
    },

    'slash': function () {
      return 'slash';
    },

    'run': function () {
      return 'run';
    }
  };

  if (typeof actions[action] !== 'function') {
    throw new Error('Invalid action.');
  }

  return actions[action]();
}
```

因此，避免使用 switch...case 结构，用对象结构代替。

### eval 函数

eval 函数的作用是将一段字符串当作语句执行。问题是 eval 不提供单独的作用域，而是直接在当前作用域运行。这会造成在不知不觉中，eval 中的语句在当前作用域创建新变量、修改已有的变量，使得恶意代码有机可乘。下面就是一个例子。

```
eval('var x = 10');
```

因此，避免使用 eval 函数。

## 参考链接

*   Eric Elliott, Programming JavaScript Applications, [Chapter 2\. JavaScript Style Guide](http://chimera.labs.oreilly.com/books/1234000000262/ch02.html), O'reilly, 2013.
*   Axel Rauschmayer, [A meta style guide for JavaScript](http://www.2ality.com/2013/07/meta-style-guide.html)